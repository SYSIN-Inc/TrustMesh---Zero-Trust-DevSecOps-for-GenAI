stages:
  - security-scan
  - build
  - validate
  - deploy

variables:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: secure-agent-ops
  DOCKER_DRIVER: overlay2

security-scan:
  stage: security-scan
  image: python:3.11
  before_script:
    - pip install -r gatekeeper/requirements.txt
  script:
    - echo "Running security scan..."
    - python -m gatekeeper.security_scanner || true
    - ./scripts/generate-sbom.sh gatekeeper sbom-gatekeeper.json || true
  artifacts:
    paths:
      - sbom-*.json
    expire_in: 30 days

build-gatekeeper:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache aws-cli
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set region $AWS_REGION
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - cd gatekeeper
    - docker build -t $ECR_REGISTRY/gatekeeper:$CI_COMMIT_SHA .
    - docker push $ECR_REGISTRY/gatekeeper:$CI_COMMIT_SHA
    - docker tag $ECR_REGISTRY/gatekeeper:$CI_COMMIT_SHA $ECR_REGISTRY/gatekeeper:latest
    - docker push $ECR_REGISTRY/gatekeeper:latest
  only:
    - main
    - develop

build-agent:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache aws-cli
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set region $AWS_REGION
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - cd agents/customer-support-agent
    - docker build -t $ECR_REGISTRY/customer-support-agent:$CI_COMMIT_SHA .
    - docker push $ECR_REGISTRY/customer-support-agent:$CI_COMMIT_SHA
  only:
    - main
    - develop

validate-security:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq kubectl aws-cli
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION
  script:
    - |
      GATEKEEPER_POD=$(kubectl -n secureagentops get pod -l app=security-gatekeeper -o jsonpath='{.items[0].metadata.name}')
      kubectl -n secureagentops port-forward $GATEKEEPER_POD 8080:8080 &
      sleep 5
      
      # Run security scan
      curl -X POST http://localhost:8080/api/v1/scan \
        -H "Content-Type: application/json" \
        -d '{
          "agent_path": "/app",
          "agent_id": "ci-agent",
          "agent_version": "$CI_COMMIT_SHA",
          "enable_trivy": true
        }' > scan_results.json
      
      # Check if passed
      SCAN_PASSED=$(cat scan_results.json | jq -r '.passed // false')
      if [ "$SCAN_PASSED" != "true" ]; then
        echo "❌ Security scan failed!"
        cat scan_results.json | jq '.'
        exit 1
      fi
      
      echo "✅ Security scan passed!"
  only:
    - main
    - develop

deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache kubectl aws-cli
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION
  script:
    - |
      kubectl -n secureagentops set image deploy/security-gatekeeper \
        security-gatekeeper=$ECR_REGISTRY/gatekeeper:$CI_COMMIT_SHA
      
      kubectl -n secureagentops set image deploy/customer-support-agent \
        customer-support-agent=$ECR_REGISTRY/customer-support-agent:$CI_COMMIT_SHA
      
      kubectl -n secureagentops rollout status deploy/security-gatekeeper
      kubectl -n secureagentops rollout status deploy/customer-support-agent
  only:
    - main
  environment:
    name: production
    url: https://secureagentops.example.com


